generator client {
  provider        = "prisma-client-js"
  output          = "../generated/node"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "rhel-openssl-3.0.x", "linux-arm64-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

generator edge {
  provider        = "prisma-client-js"
  output          = "../generated/edge"
  previewFeatures = ["driverAdapters", "postgresqlExtensions"]
  binaryTargets   = ["native"]
}

generator zod {
  provider = "zod-prisma-types"
  output   = "../generated/zod-prisma-validators"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id                   String     @id
  firstName            String?
  lastName             String?
  username             String?    @unique
  primaryEmailAddress  String     @unique
  imageUrl             String?
  clerkUserProperties  Json?
  stripeCustomerId     String?    @unique
  accessType           AccessType @default(FREE)
  stripeUserProperties Json?
  /// @deprecated Legacy Gif Avatar feature - used by editor router
  dailyAIcomments      Int        @default(0)
  /// @deprecated Legacy Gif Avatar feature - used by editor and social routers for credit system
  creditConsumed       Int        @default(-2)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  // Relations
  hostedActivities Activity[]    @relation("HostedActivities")
  participations   Participant[] @relation("Participations")
}

enum AccessType {
  FREE
  WEEKLY
  MONTHLY
  YEARLY
}

enum ActivityType {
  WORKDATE
  STUDYDATE
  HANGOUT
  SPORTS
  EVENT
  OTHER
}

enum ActivityStatus {
  OPEN
  FULL
  CANCELLED
  COMPLETED
}

enum ParticipantStatus {
  PENDING
  APPROVED
  REJECTED
}

/// @deprecated Legacy Gif Avatar feature - used by editor router
/// Minimal asset tracking for Gif Avatar
model UserUpload {
  id             String   @id @default(cuid())
  userId         String
  path           String
  mime           String
  defaultStyle   String?
  defaultBgColor String?
  createdAt      DateTime @default(now())

  @@index([userId])
}

/// @deprecated Legacy Gif Avatar feature - used by editor router
model BackgroundRemoved {
  id             String   @id @default(cuid())
  userId         String
  sourceUploadId String
  path           String
  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([sourceUploadId])
}

/// @deprecated Legacy Gif Avatar feature - used by editor router
model UserResult {
  id             String   @id @default(cuid())
  userId         String
  path           String
  sourceUploadId String?
  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([sourceUploadId])
}

/// @deprecated Legacy Social Referral feature - used by social router
enum SocialPlatform {
  X
  THREADS
  FACEBOOK
  LINKEDIN
}

/// @deprecated Legacy Social Referral feature - used by social router
enum SocialSubmissionStatus {
  VERIFYING
  VALIDATED
  INVALID
  DUPLICATE
  VALIDATION_FAILED
}

/// @deprecated Legacy Social Referral feature - used by social router
model SocialSubmission {
  id                  String                 @id @default(cuid())
  userId              String
  platform            SocialPlatform
  originalUrl         String
  urlNormalized       String                 @unique
  status              SocialSubmissionStatus @default(VERIFYING)
  requiredKeywords    String[]
  missingKeywords     String[]
  matchedKeywords     String[]
  postText            String?
  likes               Int                    @default(0)
  comments            Int                    @default(0)
  shares              Int                    @default(0)
  bestEngagementTotal Int                    @default(0)
  creditAwarded       Int                    @default(0)
  creditPenalty       Int                    @default(0)
  rescanCount         Int                    @default(0)
  verifiedAt          DateTime?
  lastAttemptAt       DateTime?
  errorMessage        String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  @@index([userId, status])
  @@index([userId, createdAt])
}

model Activity {
  id              String         @id @default(cuid())
  hostId          String
  type            ActivityType
  name            String
  description     String
  tags            String[]
  dateTime        DateTime
  location        String
  coverPhoto      String
  imageUrls       String[]
  maxParticipants Int            @default(4)
  status          ActivityStatus @default(OPEN)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  host         User          @relation("HostedActivities", fields: [hostId], references: [id], onDelete: Cascade)
  participants Participant[]

  @@index([hostId])
  @@index([dateTime])
  @@index([status, dateTime])
}

model Participant {
  id         String            @id @default(cuid())
  userId     String
  activityId String
  status     ParticipantStatus @default(PENDING)
  joinedAt   DateTime          @default(now())

  user     User     @relation("Participations", fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
}
